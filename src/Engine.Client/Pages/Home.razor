@page "/"
@using System.Collections.Generic
@using System.Globalization
@using System.Linq
@using System.Threading
@using Engine.Client.Rendering
@using Engine.Client.Services
@using Engine.Core.Accounts
@using Engine.Core.Contracts
@inject GraphicsSettingsClient GraphicsClient
@inject LeaderboardClient LeaderboardClient
@inject SessionClient SessionClient
@inject RenderLoopService RenderLoop
@inject AccountClient AccountClient
@inject StatisticsClient StatisticsClient
@inject DashboardLayoutClient LayoutClient
@inject ModuleViewClient ModuleViewClient
@inject SpriteLibraryClient SpriteClient
@inject NavigationManager Navigation
@inject IJSRuntime JsRuntime
@inject ClientErrorReporter ErrorReporter
@inject RuntimeConfigClient RuntimeConfigClient

@implements IAsyncDisposable

<PageTitle>Mission Control</PageTitle>

@if (_user is null)
{
	<section class="auth-gate" aria-label="Account onboarding">
		<div class="auth-panel">
			<header>
				<div>
					<p>Link Your Pilot Identity</p>
					<small>Create an account or sign in to access Mission Control.</small>
				</div>
				@if (IsDeveloperAutoLoginEnabled)
				{
					<span class="auth-badge">Developer mode</span>
				}
			</header>
			@if (!string.IsNullOrWhiteSpace(_authStatus))
			{
				<p class="auth-status">@_authStatus</p>
			}
			@if (!string.IsNullOrWhiteSpace(_authError))
			{
				<p class="auth-error">@_authError</p>
			}
			<div class="auth-columns">
				<article>
					<h3>Sign in</h3>
					<div class="form-stack">
						<label>Email</label>
						<input type="email" @bind="_loginForm.Email" autocomplete="username"/>
						<label>Password</label>
						<input type="password" @bind="_loginForm.Password" autocomplete="current-password"/>
					</div>
					<button type="button" @onclick="LoginAsync" disabled="@_authBusy">Enter hangar</button>
				</article>
				<article>
					<h3>Create account</h3>
					<div class="form-stack">
						<label>Display name</label>
						<input type="text" maxlength="24" @bind="_signupForm.DisplayName" autocomplete="nickname"/>
						<label>Email</label>
						<input type="email" @bind="_signupForm.Email" autocomplete="email"/>
						<label>Password</label>
						<input type="password" @bind="_signupForm.Password" autocomplete="new-password"/>
					</div>
					<button type="button" @onclick="RegisterAsync" disabled="@_authBusy">Begin ascent</button>
				</article>
			</div>
		</div>
	</section>
}
else
{
	<main class="dashboard-grid" aria-label="Mission Control overview">
		@if (!string.IsNullOrWhiteSpace(_fatalError))
		{
			<section class="panel error-state full-span">
				<header>
					<div>
						<p>Telemetry Offline</p>
						<small>Resolve the issue, then retry syncing.</small>
					</div>
					<button class="ghost" @onclick="RefreshAllAsync">Retry sync</button>
				</header>
				<p>@_fatalError</p>
			</section>
		}
		else if (!string.IsNullOrWhiteSpace(_statusError))
		{
			<section class="panel warning-state full-span">
				<header>
					<div>
						<p>Partial Degradation</p>
						<small>Some panels are stale; retry once stable.</small>
					</div>
					<button class="ghost" @onclick="RefreshAllAsync">Retry sync</button>
				</header>
				<p>@_statusError</p>
			</section>
		}

		@foreach (var panel in _dashboardPanels)
		{
			<section @key="panel.Id" class="@BuildPanelClass(panel)" style="@BuildPanelStyle(panel)" data-zone="@panel.Zone">
				@switch (panel.Id)
				{
					case DashboardViewIds.Simulation:
						<header>
							<div>
								<p>@panel.Title</p>
								<small>@_currentSettings.TargetFps fps · @_currentSettings.GpuTier</small>
							</div>
							<div class="simulation-meta">
								<span>@_playerId</span>
								<span>@GetActiveSkillName()</span>
							</div>
						</header>
						<canvas class="render-surface" @ref="_canvasRef" width="512" height="512" aria-label="GPU preview"></canvas>
						<footer>
							<button class="ghost" @onclick="RefreshAllAsync">Refresh telemetry</button>
							<span class="rate-pill">@GetActiveSkillRate()</span>
						</footer>
						break;
					case DashboardViewIds.Statistics:
						@if (_moduleViewDocuments.TryGetValue(panel.Id, out var statisticsDocument))
						{
							<ModuleViewPanel Document="statisticsDocument"
							                 OnSelection="HandleModuleSelectionAsync"
							                 OnAction="HandleModuleActionAsync"/>
						}
						else
						{
							<header>
								<div>
									<p>@panel.Title</p>
									<small>Tracking deterministic telemetry</small>
								</div>
								<span class="rate-pill">@GetActiveSkillRate()</span>
							</header>
							<p class="panel-placeholder">Statistics module has not provided a view yet.</p>
						}

						break;
					case DashboardViewIds.AccountUniverse:
						@if (_moduleViewDocuments.TryGetValue(panel.Id, out var accountDocument))
						{
							<ModuleViewPanel Document="accountDocument"
							                 OnSelection="HandleModuleSelectionAsync"
							                 OnAction="HandleModuleActionAsync"/>
						}
						else
						{
							<header>
								<div>
									<p>@panel.Title</p>
									<small>Spin up universes and mint characters</small>
								</div>
							</header>
							<p class="panel-placeholder">Account module has not provided a view yet.</p>
						}

						break;
					case DashboardViewIds.Graphics:
						@if (_moduleViewDocuments.TryGetValue(panel.Id, out var graphicsDocument))
						{
							<ModuleViewPanel Document="graphicsDocument"
							                 OnSelection="HandleModuleSelectionAsync"
							                 OnAction="HandleModuleActionAsync"/>
						}
						else
						{
							<header>
								<div>
									<p>@panel.Title</p>
									<small>Graphics, audio, and misc controls relocated</small>
								</div>
							</header>
							<div class="panel-placeholder">
								<p>All tuning controls now live on the Settings page for a focused workflow.</p>
								<NavLink class="ghost" href="/settings">Open Settings</NavLink>
							</div>
						}

						break;
					case DashboardViewIds.Leaderboard:
						@if (_moduleViewDocuments.TryGetValue(panel.Id, out var leaderboardDocument))
						{
							<ModuleViewPanel Document="leaderboardDocument"
							                 OnSelection="HandleModuleSelectionAsync"
							                 OnAction="HandleModuleActionAsync"/>
						}
						else
						{
							<header>
								<div>
									<p>@panel.Title</p>
									<small>Real-time scores pushed via SignalR</small>
								</div>
							</header>
							<p class="panel-placeholder">Leaderboard module has not provided a view yet.</p>
						}

						break;
					case DashboardViewIds.Sessions:
						@if (_moduleViewDocuments.TryGetValue(panel.Id, out var sessionsDocument))
						{
							<ModuleViewPanel Document="sessionsDocument"
							                 OnSelection="HandleModuleSelectionAsync"
							                 OnAction="HandleModuleActionAsync"/>
						}
						else
						{
							<header>
								<div>
									<p>@panel.Title</p>
									<small>Authoritative instancing overview</small>
								</div>
							</header>
							<p class="panel-placeholder">Sessions module has not provided a view yet.</p>
						}

						break;
					default:
						<header>
							<div>
								<p>@panel.Title</p>
								<small>@panel.Description</small>
							</div>
						</header>
						<p class="panel-placeholder">Module '@panel.Module' has not provided a client view yet.</p>
						break;
				}
			</section>
		}
	</main>
}

@code {
	private const string DefaultSpriteId = "avatars/ember-nomad";
	private const string DefaultSkillAccent = "#72f5ff";

	private static readonly IReadOnlyDictionary<string, string> SpriteFallbacks =
		new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
		{
			[DefaultSpriteId] = "images/avatars/ember-nomad.svg"
		};

	private static readonly IReadOnlyDictionary<string, int> ZoneOrdering =
		new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase)
		{
			[DashboardViewZones.Hero] = 0,
			[DashboardViewZones.Primary] = 1,
			[DashboardViewZones.Secondary] = 2
		};

	private bool IsDeveloperAutoLoginEnabled =>
		_runtimeConfig.DeveloperAutoLoginEnabled && _runtimeConfig.DeveloperAutoLogin is not null;

	private RenderSettings _currentSettings = RenderSettings.Balanced;
	private IReadOnlyList<UniverseRecord> _universes = Array.Empty<UniverseRecord>();
	private IReadOnlyList<CharacterRecord> _characters = Array.Empty<CharacterRecord>();
	private IReadOnlyList<DashboardViewDescriptorDto> _dashboardPanels = Array.Empty<DashboardViewDescriptorDto>();

	private IReadOnlyDictionary<string, ModuleViewDocument> _moduleViewDocuments =
		new Dictionary<string, ModuleViewDocument>(StringComparer.OrdinalIgnoreCase);

	private StatisticsSnapshotDto _statistics = new();
	private AccountWalletSnapshotDto _walletSnapshot = new();
	private RuntimeConfigDto _runtimeConfig = new();
	private UniverseRecord? _selectedUniverse;
	private UserRecord? _user;
	private SpriteDefinitionDto? _spriteDefinition;
	private SpriteAnimationDescriptor? _heroAnimation;
	private string _playerId = GeneratePilotId();
	private double _skillCurrencyBuffer;
	private double _lastSkillCurrencyTotal;
	private bool _busy;
	private bool _universeBusy;
	private bool _runtimeConfigLoaded;
	private string? _universeError;
	private ElementReference _canvasRef;
	private bool _renderReady;
	private string? _fatalError;
	private string? _statusError;
	private CancellationTokenSource? _statisticsLoopCts;
	private Task? _statisticsLoopTask;
	private bool _authBusy;
	private string? _authError;
	private string? _authStatus;
	private WalletTab _walletTab = WalletTab.Account;
	private LoginFormModel _loginForm = new();
	private SignupFormModel _signupForm = new();

	protected override async Task OnInitializedAsync()
	{
		_playerId = GeneratePilotId();
		await RefreshAllAsync();
	}

	private static string GeneratePilotId()
	{
		var raw = Guid.NewGuid().ToString("N");
		return $"pilot-{raw[..6]}";
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender && _renderReady)
		{
			try
			{
				await RenderLoop.InitializeAsync(_canvasRef, _currentSettings, _heroAnimation);
			}
			catch (Exception ex)
			{
				await HandleErrorAsync(nameof(RenderLoop.InitializeAsync), ex, fatal: false);
			}
		}
	}

	private async Task RefreshAllAsync()
	{
		if (_busy)
		{
			return;
		}

		_busy = true;
		try
		{
			await EnsureRuntimeConfigAsync();
			await EnsureUserAsync();
			if (_user is null)
			{
				return;
			}

			var graphicsTask = GraphicsClient.GetAsync();
			var universeTask = RefreshUniverseDataAsync();
			var layoutTask = LayoutClient.ListAsync();
			var statisticsTask = StatisticsClient.GetSnapshotAsync();
			var spriteTask = SpriteClient.GetAsync(DefaultSpriteId);
			var moduleViewTask = ModuleViewClient.ListAsync(_user.Id, BuildModuleViewParameters());

			_currentSettings = await graphicsTask;
			await universeTask;
			await RefreshWalletSnapshotAsync();

			var layouts = await layoutTask;
			_dashboardPanels = SortPanels(EnsureDefaultPanels(layouts));
			_statistics = await statisticsTask;
			_lastSkillCurrencyTotal = _statistics.TotalSkillCurrency;
			_spriteDefinition = await spriteTask;
			var moduleViews = await moduleViewTask;
			_moduleViewDocuments = BuildModuleViewLookup(moduleViews);
			UpdateHeroAnimation();
			if (_heroAnimation is not null)
			{
				await RenderLoop.PlayAnimationAsync(_heroAnimation);
			}

			_fatalError = null;
			_statusError = null;
			_renderReady = true;
			EnsureStatisticsRefreshLoop();
		}
		catch (Exception ex)
		{
			await HandleErrorAsync(nameof(RefreshAllAsync), ex, fatal: true);
		}
		finally
		{
			_busy = false;
			StateHasChanged();
		}
	}

	private async Task RefreshModuleViewsAsync(CancellationToken cancellationToken = default)
	{
		if (_user is null)
		{
			_moduleViewDocuments = new Dictionary<string, ModuleViewDocument>(StringComparer.OrdinalIgnoreCase);
			return;
		}

		try
		{
			var documents = await ModuleViewClient.ListAsync(_user.Id, BuildModuleViewParameters(), cancellationToken);
			_moduleViewDocuments = BuildModuleViewLookup(documents);
		}
		catch (Exception ex)
		{
			await HandleErrorAsync(nameof(RefreshModuleViewsAsync), ex, fatal: false, updateStatus: false);
		}
	}

	private async Task EnsureRuntimeConfigAsync()
	{
		if (_runtimeConfigLoaded)
		{
			return;
		}

		try
		{
			_runtimeConfig = await RuntimeConfigClient.GetAsync();
			_runtimeConfigLoaded = true;
		}
		catch (Exception ex)
		{
			await HandleErrorAsync(nameof(EnsureRuntimeConfigAsync), ex, fatal: true);
		}
	}

	private async Task EnsureUserAsync()
	{
		if (_user is not null)
		{
			return;
		}

		string? storedId = null;
		try
		{
			storedId = await JsRuntime.InvokeAsync<string?>("localStorage.getItem", "afk.userId");
		}
		catch
		{
			// Storage unavailable; proceed with interactive auth.
		}

		if (!string.IsNullOrWhiteSpace(storedId))
		{
			try
			{
				var existing = await AccountClient.GetUserAsync(storedId);
				if (existing is not null)
				{
					await OnUserAuthenticatedAsync(existing, persist: false);
					return;
				}
			}
			catch (AccountClientException ex)
			{
				_universeError ??= ex.Message;
				await HandleErrorAsync(nameof(EnsureUserAsync), ex, updateStatus: false);
			}
		}

		if (IsDeveloperAutoLoginEnabled)
		{
			await AutoLoginDeveloperAsync();
		}
	}

	private async Task AutoLoginDeveloperAsync()
	{
		if (!IsDeveloperAutoLoginEnabled || _runtimeConfig.DeveloperAutoLogin is null)
		{
			return;
		}

		if (_authBusy)
		{
			return;
		}

		_authBusy = true;
		_authStatus = "Provisioning developer account...";
		_authError = null;
		try
		{
			var descriptor = _runtimeConfig.DeveloperAutoLogin;
			var user = await AccountClient.AuthenticateAsync(descriptor.Email, descriptor.Password);
			if (user is null)
			{
				user = await AccountClient.RegisterUserAsync(descriptor.Email, descriptor.Password,
					descriptor.DisplayName);
			}

			await OnUserAuthenticatedAsync(user);
			_authStatus = null;
		}
		catch (AccountClientException ex)
		{
			_authError = ex.Message;
			await HandleErrorAsync(nameof(AutoLoginDeveloperAsync), ex, updateStatus: false);
		}
		finally
		{
			_authBusy = false;
		}
	}

	private async Task OnUserAuthenticatedAsync(UserRecord user, bool persist = true)
	{
		_user = user;
		_authError = null;
		_authStatus = null;
		if (persist)
		{
			await PersistUserIdAsync(user.Id);
		}

		_skillCurrencyBuffer = 0;
		_lastSkillCurrencyTotal = _statistics.TotalSkillCurrency;
		await RefreshUniverseDataAsync();
		await RefreshWalletSnapshotAsync();
	}

	private async Task LoginAsync()
	{
		if (_authBusy)
		{
			return;
		}

		_authBusy = true;
		_authError = null;
		try
		{
			if (string.IsNullOrWhiteSpace(_loginForm.Email) || string.IsNullOrWhiteSpace(_loginForm.Password))
			{
				_authError = "Email and password are required.";
				return;
			}

			var email = _loginForm.Email.Trim();
			var password = _loginForm.Password.Trim();
			var user = await AccountClient.AuthenticateAsync(email, password);
			if (user is null)
			{
				_authError = "Invalid credentials.";
				return;
			}

			await OnUserAuthenticatedAsync(user);
			await RefreshAllAsync();
		}
		catch (AccountClientException ex)
		{
			_authError = ex.Message;
			await HandleErrorAsync(nameof(LoginAsync), ex, updateStatus: false);
		}
		finally
		{
			_authBusy = false;
		}
	}

	private async Task RegisterAsync()
	{
		if (_authBusy)
		{
			return;
		}

		_authBusy = true;
		_authError = null;
		try
		{
			if (string.IsNullOrWhiteSpace(_signupForm.DisplayName) ||
			    string.IsNullOrWhiteSpace(_signupForm.Email) ||
			    string.IsNullOrWhiteSpace(_signupForm.Password))
			{
				_authError = "Display name, email, and password are required.";
				return;
			}

			var displayName = _signupForm.DisplayName.Trim();
			var email = _signupForm.Email.Trim();
			var password = _signupForm.Password.Trim();
			var user = await AccountClient.RegisterUserAsync(email, password, displayName);
			await OnUserAuthenticatedAsync(user);
			await RefreshAllAsync();
		}
		catch (AccountClientException ex)
		{
			_authError = ex.Message;
			await HandleErrorAsync(nameof(RegisterAsync), ex, updateStatus: false);
		}
		finally
		{
			_authBusy = false;
		}
	}

	private async Task PersistUserIdAsync(string userId)
	{
		try
		{
			await JsRuntime.InvokeVoidAsync("localStorage.setItem", "afk.userId", userId);
		}
		catch
		{
			// Ignore persistence errors; the UI will simply reprovision later.
		}
	}

	private async Task RefreshUniverseDataAsync()
	{
		if (_user is null)
		{
			_universes = Array.Empty<UniverseRecord>();
			_characters = Array.Empty<CharacterRecord>();
			return;
		}

		try
		{
			var universes = await AccountClient.GetUniversesAsync(_user.Id);
			_universes = universes;
			if (_selectedUniverse is null || !_universes.Any(u => u.Id == _selectedUniverse.Id))
			{
				_selectedUniverse = _universes.FirstOrDefault();
			}

			if (_selectedUniverse is not null)
			{
				_characters = await AccountClient.GetCharactersAsync(_selectedUniverse.Id);
			}
			else
			{
				_characters = Array.Empty<CharacterRecord>();
			}

			_universeError = null;
		}
		catch (AccountClientException ex)
		{
			_universeError = ex.Message;
			_characters = Array.Empty<CharacterRecord>();
			await HandleErrorAsync(nameof(RefreshUniverseDataAsync), ex, updateStatus: false);
		}
	}

	private async Task RefreshWalletSnapshotAsync()
	{
		if (_user is null)
		{
			_walletSnapshot = new AccountWalletSnapshotDto();
			return;
		}

		try
		{
			_walletSnapshot = await AccountClient.GetWalletsAsync(_user.Id);
		}
		catch (AccountClientException ex)
		{
			await HandleErrorAsync(nameof(RefreshWalletSnapshotAsync), ex, updateStatus: false);
		}
	}

	private async Task LoadCharactersForSelectionAsync()
	{
		if (_selectedUniverse is null)
		{
			_characters = Array.Empty<CharacterRecord>();
			return;
		}

		try
		{
			_characters = await AccountClient.GetCharactersAsync(_selectedUniverse.Id);
			_universeError = null;
		}
		catch (AccountClientException ex)
		{
			_universeError = ex.Message;
			await HandleErrorAsync(nameof(LoadCharactersForSelectionAsync), ex, updateStatus: false);
		}
	}

	private async Task CreateUniverseAsync(string? requestedName = null)
	{
		if (_user is null || _universeBusy)
		{
			return;
		}

		_universeBusy = true;
		try
		{
			var name = string.IsNullOrWhiteSpace(requestedName)
				? $"Universe {_universes.Count + 1}"
				: requestedName.Trim();
			var universe = await AccountClient.CreateUniverseAsync(_user.Id, name);
			_selectedUniverse = universe;
			await RefreshUniverseDataAsync();
			await RefreshWalletSnapshotAsync();
		}
		catch (AccountClientException ex)
		{
			_universeError = ex.Message;
			await HandleErrorAsync(nameof(CreateUniverseAsync), ex, updateStatus: false);
		}
		catch (Exception ex)
		{
			_universeError ??= "Unexpected error while creating a universe.";
			await HandleErrorAsync(nameof(CreateUniverseAsync), ex);
		}
		finally
		{
			_universeBusy = false;
		}
	}

	private async Task CreateCharacterAsync(string? requestedName = null)
	{
		if (_selectedUniverse is null || _universeBusy)
		{
			return;
		}

		_universeBusy = true;
		try
		{
			var name = string.IsNullOrWhiteSpace(requestedName) ? null : requestedName.Trim();
			await AccountClient.CreateCharacterAsync(_selectedUniverse.Id, name);
			await LoadCharactersForSelectionAsync();
			await RefreshWalletSnapshotAsync();
		}
		catch (AccountClientException ex)
		{
			_universeError = ex.Message;
			await HandleErrorAsync(nameof(CreateCharacterAsync), ex, updateStatus: false);
		}
		catch (Exception ex)
		{
			_universeError ??= "Unexpected error while creating a character.";
			await HandleErrorAsync(nameof(CreateCharacterAsync), ex);
		}
		finally
		{
			_universeBusy = false;
		}
	}

	private async Task RefreshLeaderboardAsync()
	{
		try
		{
			_statusError = null;
			await RefreshModuleViewsAsync();
		}
		catch (Exception ex)
		{
			await HandleErrorAsync(nameof(RefreshLeaderboardAsync), ex);
		}
	}

	private async Task SubmitScoreAsync(string displayName, double requestedScore)
	{
		try
		{
			var score = Math.Max(0d, requestedScore);
			await LeaderboardClient.SubmitAsync(_playerId, displayName, score);
			await RefreshLeaderboardAsync();
		}
		catch (Exception ex)
		{
			await HandleErrorAsync(nameof(SubmitScoreAsync), ex);
		}
	}

	private async Task RefreshSessionsAsync()
	{
		try
		{
			_statusError = null;
			await RefreshModuleViewsAsync();
		}
		catch (Exception ex)
		{
			await HandleErrorAsync(nameof(RefreshSessionsAsync), ex);
		}
	}

	private async Task CreateSessionAsync(string? requestedName = null)
	{
		var sessionName = string.IsNullOrWhiteSpace(requestedName)
			? $"Node {DateTimeOffset.Now:HHmmss}"
			: requestedName.Trim();

		try
		{
			await SessionClient.CreateAsync(sessionName);
			await RefreshSessionsAsync();
		}
		catch (Exception ex)
		{
			await HandleErrorAsync(nameof(CreateSessionAsync), ex);
		}
	}

	private async Task JoinSessionAsync(string sessionId)
	{
		try
		{
			await SessionClient.JoinAsync(sessionId, _playerId);
			await RefreshSessionsAsync();
		}
		catch (Exception ex)
		{
			await HandleErrorAsync(nameof(JoinSessionAsync), ex);
		}
	}

	private void EnsureStatisticsRefreshLoop()
	{
		if (_statisticsLoopTask is { IsCompleted: false })
		{
			return;
		}

		_statisticsLoopCts?.Cancel();
		_statisticsLoopCts?.Dispose();
		_statisticsLoopCts = new CancellationTokenSource();
		_statisticsLoopTask = RunStatisticsRefreshLoopAsync(_statisticsLoopCts.Token);
	}

	private async Task RunStatisticsRefreshLoopAsync(CancellationToken token)
	{
		using var timer = new PeriodicTimer(TimeSpan.FromSeconds(1));
		try
		{
			while (await timer.WaitForNextTickAsync(token).ConfigureAwait(false))
			{
				StatisticsSnapshotDto? snapshot;
				try
				{
					snapshot = await StatisticsClient.GetSnapshotAsync(token).ConfigureAwait(false);
				}
				catch (OperationCanceledException)
				{
					break;
				}
				catch (Exception ex)
				{
					await InvokeAsync(async () => { await HandleErrorAsync(nameof(RunStatisticsRefreshLoopAsync), ex, fatal: false, updateStatus: false); });
					continue;
				}

				if (snapshot is null)
				{
					continue;
				}

				await TryDepositSkillCurrencyAsync(snapshot.TotalSkillCurrency, token).ConfigureAwait(false);

				await InvokeAsync(() =>
				{
					_statistics = snapshot;
					UpdateHeroAnimation();
					StateHasChanged();
					return Task.CompletedTask;
				});
			}
		}
		catch (OperationCanceledException)
		{
			// Graceful shutdown.
		}
	}

	private async Task TryDepositSkillCurrencyAsync(double totalCurrency, CancellationToken token)
	{
		if (_user is null)
		{
			_skillCurrencyBuffer = 0;
			_lastSkillCurrencyTotal = 0;
			return;
		}

		if (totalCurrency <= _lastSkillCurrencyTotal)
		{
			return;
		}

		_skillCurrencyBuffer += totalCurrency - _lastSkillCurrencyTotal;
		_lastSkillCurrencyTotal = totalCurrency;
		if (_skillCurrencyBuffer < 1d)
		{
			return;
		}

		var grant = (long)Math.Floor(_skillCurrencyBuffer);
		if (grant <= 0)
		{
			return;
		}

		var characterId = ResolveDepositCharacterId();
		if (string.IsNullOrWhiteSpace(characterId))
		{
			return;
		}

		try
		{
			var snapshot = await AccountClient.DepositWalletAsync(_user.Id,
				new WalletDepositDto
				{
					BaseCurrency = grant,
					PremiumCurrency = 0,
					CharacterId = characterId
				}, token).ConfigureAwait(false);
			_skillCurrencyBuffer -= grant;
			await InvokeAsync(async () =>
			{
				_walletSnapshot = snapshot;
				await LoadCharactersForSelectionAsync();
				StateHasChanged();
			});
		}
		catch (AccountClientException ex)
		{
			await HandleErrorAsync(nameof(TryDepositSkillCurrencyAsync), ex, updateStatus: false);
		}
	}

	private string? ResolveDepositCharacterId()
	{
		if (_characters.Count > 0)
		{
			return _characters[0].Id;
		}

		var candidate = _walletSnapshot.Characters.FirstOrDefault();
		return candidate?.CharacterId;
	}

	public async ValueTask DisposeAsync()
	{
		_statisticsLoopCts?.Cancel();
		if (_statisticsLoopTask is not null)
		{
			try
			{
				await _statisticsLoopTask.ConfigureAwait(false);
			}
			catch (OperationCanceledException)
			{
				// Expected during disposal.
			}
		}

		_statisticsLoopCts?.Dispose();
		_statisticsLoopCts = null;
		try
		{
			await RenderLoop.DisposeAsync();
		}
		catch (Exception ex)
		{
			await HandleErrorAsync(nameof(RenderLoop.DisposeAsync), ex, updateStatus: false);
		}
	}

	private async Task HandleErrorAsync(string operation, Exception exception, bool fatal = false, bool updateStatus = true)
	{
		await ErrorReporter.ReportAsync(operation, exception);
		await Console.Error.WriteLineAsync($"[{operation}] {exception}");
		var message = $"{operation} failed: {exception.Message}";
		if (fatal)
		{
			_fatalError = message;
			_renderReady = false;
		}
		else if (updateStatus)
		{
			_statusError = message;
		}
	}

	private static IEnumerable<(string Label, string Value)> EnumerateEquipment(EquipmentSlots equipment)
	{
		yield return ("Head", SlotValue(equipment.Head));
		yield return ("Cape", SlotValue(equipment.Cape));
		yield return ("Neck", SlotValue(equipment.Neck));
		yield return ("Weapon", SlotValue(equipment.Weapon));
		yield return ("Shield", SlotValue(equipment.Shield));
		yield return ("Body", SlotValue(equipment.Body));
		yield return ("Legs", SlotValue(equipment.Legs));
		yield return ("Feet", SlotValue(equipment.Feet));
		yield return ("Hands", SlotValue(equipment.Hands));
	}

	private static string SlotValue(string? slot) => string.IsNullOrWhiteSpace(slot) ? "—" : slot!;

	private string ResolveSprite(string? spriteId)
	{
		if (!string.IsNullOrWhiteSpace(spriteId))
		{
			if (string.Equals(spriteId, DefaultSpriteId, StringComparison.OrdinalIgnoreCase) &&
			    _spriteDefinition is not null && !string.IsNullOrWhiteSpace(_spriteDefinition.AssetPath))
			{
				return NormalizeAssetPath(_spriteDefinition.AssetPath);
			}

			if (SpriteFallbacks.TryGetValue(spriteId, out var mapped))
			{
				return mapped;
			}
		}

		if (_spriteDefinition is not null && !string.IsNullOrWhiteSpace(_spriteDefinition.AssetPath))
		{
			return NormalizeAssetPath(_spriteDefinition.AssetPath);
		}

		return SpriteFallbacks[DefaultSpriteId];
	}

	private static string NormalizeAssetPath(string path)
	{
		if (string.IsNullOrWhiteSpace(path))
		{
			return string.Empty;
		}

		return path.StartsWith("http", StringComparison.OrdinalIgnoreCase)
			? path
			: path.StartsWith('/')
				? path
				: $"/{path}";
	}

	private IReadOnlyList<DashboardViewDescriptorDto> EnsureDefaultPanels(IReadOnlyList<DashboardViewDescriptorDto> descriptors)
	{
		if (descriptors is null || descriptors.Count == 0)
		{
			return BuildDefaultPanels();
		}

		var panels = descriptors.ToList();
		var existing = new HashSet<string>(descriptors.Select(p => p.Id), StringComparer.OrdinalIgnoreCase);
		foreach (var fallback in BuildDefaultPanels())
		{
			if (existing.Add(fallback.Id))
			{
				panels.Add(fallback);
			}
		}

		return panels;
	}

	private static IReadOnlyList<DashboardViewDescriptorDto> BuildDefaultPanels() => new[]
	{
		new DashboardViewDescriptorDto
		{
			Id = DashboardViewIds.Simulation,
			Title = "Simulation View",
			Description = "Hero viewport",
			Zone = DashboardViewZones.Hero,
			Order = 0,
			ColumnSpan = 9,
			Module = "Core"
		},
		new DashboardViewDescriptorDto
		{
			Id = DashboardViewIds.Statistics,
			Title = "Statistics",
			Description = "Stat overview",
			Zone = DashboardViewZones.Primary,
			Order = 20,
			ColumnSpan = 4,
			Module = "Statistics"
		},
		new DashboardViewDescriptorDto
		{
			Id = DashboardViewIds.AccountUniverse,
			Title = "Universe Foundry",
			Description = "Manage universes",
			Zone = DashboardViewZones.Hero,
			Order = 10,
			ColumnSpan = 3,
			Module = "Accounts"
		},
		new DashboardViewDescriptorDto
		{
			Id = DashboardViewIds.Graphics,
			Title = "Graphics Controls",
			Description = "GPU tuning",
			Zone = DashboardViewZones.Secondary,
			Order = 10,
			ColumnSpan = 4,
			Module = "Core"
		},
		new DashboardViewDescriptorDto
		{
			Id = DashboardViewIds.Leaderboard,
			Title = "Global Leaderboard",
			Description = "Live scores",
			Zone = DashboardViewZones.Secondary,
			Order = 20,
			ColumnSpan = 4,
			Module = "Core"
		},
		new DashboardViewDescriptorDto
		{
			Id = DashboardViewIds.Sessions,
			Title = "Multiplayer Sessions",
			Description = "Authoritative lobbies",
			Zone = DashboardViewZones.Secondary,
			Order = 30,
			ColumnSpan = 4,
			Module = "Core"
		}
	};

	private IReadOnlyList<DashboardViewDescriptorDto> SortPanels(IEnumerable<DashboardViewDescriptorDto> panels)
	{
		return panels
			.OrderBy(panel => ZoneOrdering.TryGetValue(panel.Zone, out var rank) ? rank : int.MaxValue)
			.ThenBy(panel => panel.Order)
			.ThenBy(panel => panel.Title, StringComparer.OrdinalIgnoreCase)
			.ToArray();
	}

	private string BuildPanelClass(DashboardViewDescriptorDto panel)
	{
		var classes = new List<string> { "panel" };
		if (string.Equals(panel.Zone, DashboardViewZones.Hero, StringComparison.OrdinalIgnoreCase))
		{
			classes.Add("panel-hero");
		}

		if (IsSimulationPanel(panel.Id))
		{
			classes.Add("panel-simulation");
		}

		if (IsCompactPanel(panel.Id))
		{
			classes.Add("panel-compact");
		}

		return string.Join(' ', classes);
	}

	private void SetWalletTab(WalletTab tab)
	{
		if (_walletTab == tab)
		{
			return;
		}

		_walletTab = tab;
	}

	private string BuildWalletTabClass(WalletTab tab) => _walletTab == tab ? "wallet-tab active" : "wallet-tab";

	private static bool IsCompactPanel(string id) =>
		string.Equals(id, DashboardViewIds.Leaderboard, StringComparison.OrdinalIgnoreCase) ||
		string.Equals(id, DashboardViewIds.Graphics, StringComparison.OrdinalIgnoreCase);

	private static bool IsSimulationPanel(string id) =>
		string.Equals(id, DashboardViewIds.Simulation, StringComparison.OrdinalIgnoreCase);

	private static string BuildPanelStyle(DashboardViewDescriptorDto panel)
	{
		var span = Math.Clamp(panel.ColumnSpan, 1, 12);
		return $"grid-column: span {span};";
	}

	private IReadOnlyDictionary<string, string>? BuildModuleViewParameters()
	{
		var parameters = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
		{
			["playerAlias"] = _playerId
		};

		if (_selectedUniverse is not null)
		{
			parameters["activeUniverseId"] = _selectedUniverse.Id;
		}

		return parameters;
	}

	private static IReadOnlyDictionary<string, ModuleViewDocument> BuildModuleViewLookup(
		IReadOnlyList<ModuleViewDocument> documents)
	{
		if (documents == null || documents.Count == 0)
		{
			return new Dictionary<string, ModuleViewDocument>(StringComparer.OrdinalIgnoreCase);
		}

		return documents
			.GroupBy(document => document.Descriptor.Id, StringComparer.OrdinalIgnoreCase)
			.ToDictionary(group => group.Key, group => group.Last(), StringComparer.OrdinalIgnoreCase);
	}

	private IEnumerable<StatisticEntryDto> EnumerateStatisticEntries()
	{
		foreach (var space in _statistics.Namespaces)
		{
			foreach (var category in space.Categories)
			{
				foreach (var entry in category.Entries)
				{
					yield return entry;
				}
			}
		}
	}

	private IEnumerable<StatisticEntryDto> EnumerateSkillEntries()
	{
		foreach (var entry in EnumerateStatisticEntries())
		{
			if (string.Equals(entry.Kind, StatisticEntryKindsDto.Skill, StringComparison.OrdinalIgnoreCase))
			{
				yield return entry;
			}
		}
	}

	private StatisticEntryDto? GetActiveSkillEntry()
	{
		if (!string.IsNullOrWhiteSpace(_statistics.ActiveSkillId))
		{
			foreach (var entry in EnumerateStatisticEntries())
			{
				if (string.Equals(entry.EntryId, _statistics.ActiveSkillId, StringComparison.OrdinalIgnoreCase))
				{
					return entry;
				}
			}
		}

		foreach (var entry in EnumerateSkillEntries())
		{
			if (entry.IsActive)
			{
				return entry;
			}
		}

		foreach (var entry in EnumerateSkillEntries())
		{
			return entry;
		}

		return null;
	}

	private string BuildStatisticEntryClass(StatisticEntryDto entry)
	{
		var classes = new List<string> { "stat-entry" };
		if (string.Equals(entry.Kind, StatisticEntryKindsDto.Skill, StringComparison.OrdinalIgnoreCase))
		{
			classes.Add("stat-entry-skill");
		}

		if (entry.IsActive)
		{
			classes.Add("active");
		}

		return string.Join(' ', classes);
	}

	private string GetActiveSkillName() => GetActiveSkillEntry()?.Name ?? "Idling";

	private string GetActiveSkillRate()
	{
		var entry = GetActiveSkillEntry();
		var rate = entry?.Value.CurrencyPerSecond ?? 0d;
		return $"{rate.ToString("N1", CultureInfo.InvariantCulture)} c/s";
	}

	private Task HandleModuleSelectionAsync(ModuleViewSelection selection)
	{
		if (selection is null)
		{
			return Task.CompletedTask;
		}

		if (string.Equals(selection.DocumentId, DashboardViewIds.Statistics, StringComparison.OrdinalIgnoreCase) &&
		    string.Equals(selection.BlockId, "statistics.skills", StringComparison.OrdinalIgnoreCase))
		{
			return ActivateSkillAsync(selection.ItemId);
		}

		if (string.Equals(selection.DocumentId, DashboardViewIds.AccountUniverse, StringComparison.OrdinalIgnoreCase) &&
		    string.Equals(selection.BlockId, "accounts.universe.list", StringComparison.OrdinalIgnoreCase))
		{
			return HandleUniverseSelectionAsync(selection.ItemId);
		}

		if (string.Equals(selection.DocumentId, DashboardViewIds.Sessions, StringComparison.OrdinalIgnoreCase) &&
		    string.Equals(selection.BlockId, "core.sessions.list", StringComparison.OrdinalIgnoreCase))
		{
			return JoinSessionAsync(selection.ItemId);
		}

		return Task.CompletedTask;
	}

	private async Task HandleUniverseSelectionAsync(string universeId)
	{
		if (string.IsNullOrWhiteSpace(universeId) || _selectedUniverse?.Id == universeId)
		{
			return;
		}

		var universe = _universes.FirstOrDefault(u =>
			string.Equals(u.Id, universeId, StringComparison.OrdinalIgnoreCase));
		if (universe is null)
		{
			await RefreshUniverseDataAsync();
			universe = _universes.FirstOrDefault(u =>
				string.Equals(u.Id, universeId, StringComparison.OrdinalIgnoreCase));
			if (universe is null)
			{
				return;
			}
		}

		_selectedUniverse = universe;
		await LoadCharactersForSelectionAsync();
		await RefreshModuleViewsAsync();
	}

	private Task HandleModuleActionAsync(ModuleViewActionRequest action)
	{
		if (action is null)
		{
			return Task.CompletedTask;
		}

		if (!string.IsNullOrWhiteSpace(action.Command) &&
		    action.Command.StartsWith("navigate:", StringComparison.OrdinalIgnoreCase))
		{
			var target = action.Command[9..].Trim();
			if (!string.IsNullOrWhiteSpace(target))
			{
				Navigation.NavigateTo(target);
			}

			return Task.CompletedTask;
		}

		string? ResolveParameter(string key)
		{
			if (action.Parameters is null)
			{
				return null;
			}

			return action.Parameters.TryGetValue(key, out var value) && !string.IsNullOrWhiteSpace(value)
				? value
				: null;
		}

		return action.Command switch
		{
			"leaderboard.submit" => HandleLeaderboardSubmitActionAsync(
				ResolveParameter("alias"),
				ResolveParameter("score")),
			"leaderboard.sync" => RefreshLeaderboardAsync(),
			"sessions.refresh" => RefreshSessionsAsync(),
			"sessions.spawn" => HandleSessionSpawnActionAsync(ResolveParameter("sessionName")),
			"accounts.universes.refresh" => HandleAccountsRefreshAsync(),
			"accounts.universe.create" => HandleCreateUniverseActionAsync(ResolveParameter("name")),
			"accounts.character.create" => HandleCreateCharacterActionAsync(ResolveParameter("name")),
			_ => Task.CompletedTask
		};
	}

	private async Task HandleAccountsRefreshAsync()
	{
		await RefreshUniverseDataAsync();
		await RefreshWalletSnapshotAsync();
		await RefreshModuleViewsAsync();
	}

	private async Task HandleCreateUniverseActionAsync(string? requestedName)
	{
		await CreateUniverseAsync(requestedName);
		await RefreshModuleViewsAsync();
	}

	private async Task HandleCreateCharacterActionAsync(string? requestedName)
	{
		await CreateCharacterAsync(requestedName);
		await RefreshModuleViewsAsync();
	}

	private Task HandleSessionSpawnActionAsync(string? requestedName = null)
	{
		return CreateSessionAsync(requestedName);
	}

	private Task HandleLeaderboardSubmitActionAsync(string? requestedAlias, string? requestedScore)
	{
		var alias = string.IsNullOrWhiteSpace(requestedAlias) ? _playerId : requestedAlias.Trim();
		var score = 0d;
		if (!string.IsNullOrWhiteSpace(requestedScore) &&
		    double.TryParse(requestedScore, NumberStyles.Float, CultureInfo.InvariantCulture, out var parsed))
		{
			score = parsed;
		}

		return SubmitScoreAsync(alias, score);
	}

	private async Task ActivateSkillAsync(string skillId)
	{
		if (string.Equals(_statistics.ActiveSkillId, skillId, StringComparison.OrdinalIgnoreCase))
		{
			return;
		}

		try
		{
			var snapshot = await StatisticsClient.ActivateSkillAsync(skillId);
			_statistics = snapshot;
			_lastSkillCurrencyTotal = snapshot.TotalSkillCurrency;
			UpdateHeroAnimation();
			if (_heroAnimation is not null)
			{
				await RenderLoop.PlayAnimationAsync(_heroAnimation);
			}

			await RefreshModuleViewsAsync();
		}
		catch (Exception ex)
		{
			await HandleErrorAsync(nameof(ActivateSkillAsync), ex, updateStatus: false);
		}
	}

	private void UpdateHeroAnimation()
	{
		if (_spriteDefinition is null)
		{
			_heroAnimation = null;
			return;
		}

		var activeEntry = GetActiveSkillEntry();
		var animationName = activeEntry?.DefaultAnimation ?? "idle";
		var accent = activeEntry?.AccentColor ?? DefaultSkillAccent;
		_heroAnimation = SpriteAnimationMapper.CreateDescriptor(_spriteDefinition, animationName, accent);
	}

	private static string BuildUniverseChipClass(bool isActive) => isActive ? "account-chip active" : "account-chip";

	private enum WalletTab
	{
		Account,
		Universes,
		Characters
	}

	private sealed class LoginFormModel
	{
		public string Email { get; set; } = string.Empty;
		public string Password { get; set; } = string.Empty;
	}

	private sealed class SignupFormModel
	{
		public string DisplayName { get; set; } = string.Empty;
		public string Email { get; set; } = string.Empty;
		public string Password { get; set; } = string.Empty;
	}

}
